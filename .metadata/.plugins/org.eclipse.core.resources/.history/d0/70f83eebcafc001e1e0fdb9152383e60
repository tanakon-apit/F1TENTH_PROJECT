/*
 * Servo.c
 *
 *  Created on: Apr 17, 2024
 *      Author: kwan
 */

#include "Servo.h"

uint8_t RC_Signal_Init(
		Servo_Structure *Sx,
		float cpu_freq,
		float pwm_freq,
		bool isCHN
)
{
	HAL_TIM_Base_Start(Sx->htimx);
	if (isCHN) HAL_TIMEx_PWMN_Start(Sx->htimx, Sx->channelx);
	else HAL_TIM_PWM_Start(Sx->htimx, Sx->channelx);

	if (pwm_freq == 0)
		{
			__HAL_TIM_SET_COMPARE(Sx->htimx, Sx->channelx, 0);
			return -1;
		} else if (pwm_freq >= cpu_freq / 2.0) return -1;
		uint32_t period_cyc = (uint32_t) (cpu_freq / pwm_freq);
		uint16_t prescaler = (uint16_t) (period_cyc / 65535 + 1);
		uint16_t overflow = (uint16_t) ((period_cyc + (prescaler / 2)) / prescaler);
		__HAL_TIM_SET_PRESCALER(Sx->htimx, prescaler);
		__HAL_TIM_SET_AUTORELOAD(Sx->htimx, overflow);
		Sx->gain = overflow / 100.0;
		return 0;
}
